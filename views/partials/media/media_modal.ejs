<!-- Global Media Manager Modal -->
<div id="mediaManagerModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl p-6 relative">
    <button onclick="closeMediaModal()" class="absolute top-3 right-3 text-gray-500 hover:text-red-600 text-2xl">&times;</button>
    <h2 class="text-2xl font-bold mb-4 text-gray-800 flex items-center">
      <i class="fas fa-photo-video mr-2 text-indigo-600"></i> Media Library
    </h2>
    <div class="flex gap-4 mb-4">
      <form id="mediaUploadForm" action="/media" method="POST" enctype="multipart/form-data" class="flex items-center gap-2">
        <input type="file" name="file" required class="border border-gray-300 rounded px-2 py-1 text-sm" />
        <input type="hidden" name="type" value="image" />
        <input type="hidden" name="title" value="" />
        <button type="submit" class="bg-indigo-500 text-white px-3 py-1 rounded hover:bg-indigo-600 text-sm">Upload</button>
      </form>
      <select id="mediaFolderSelect" class="border border-gray-300 rounded px-2 py-1 text-sm">
        <option value="">All Folders</option>
        <!-- Folders will be loaded here by JS -->
      </select>
    </div>
    <div id="mediaGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 max-h-80 overflow-y-auto">
      <!-- Media thumbnails will be loaded here by JS -->
    </div>
    <div class="mt-4 flex justify-end">
      <button onclick="closeMediaModal()" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">Close</button>
    </div>
  </div>
</div>

<script>
let currentMediaFolder = '';
async function openMediaModal(onSelect) {
  window._mediaModalOnSelect = onSelect;
  document.getElementById('mediaManagerModal').classList.remove('hidden');
  await loadMediaFolders();
  await loadMediaGrid();
}
function closeMediaModal() {
  document.getElementById('mediaManagerModal').classList.add('hidden');
}
async function loadMediaFolders() {
  const select = document.getElementById('mediaFolderSelect');
  select.innerHTML = '<option value="">All Folders</option>';
  try {
    const res = await fetch('/api/media/folders');
    const folders = await res.json();
    folders.forEach(folder => {
      const opt = document.createElement('option');
      opt.value = folder._id;
      opt.textContent = folder.name;
      select.appendChild(opt);
    });
  } catch (e) { /* ignore */ }
}
async function loadMediaGrid(folderId = '') {
  currentMediaFolder = folderId;
  const grid = document.getElementById('mediaGrid');
  grid.innerHTML = '<div class="col-span-full text-center text-gray-400">Loading...</div>';
  try {
    const res = await fetch('/api/media' + (folderId ? ('?folder=' + folderId) : ''));
    const media = await res.json();
    if (!media.length) {
      grid.innerHTML = '<div class="col-span-full text-center text-gray-400">No media found.</div>';
      return;
    }
    grid.innerHTML = '';
    media.forEach(item => {
      const div = document.createElement('div');
      div.className = 'cursor-pointer border rounded p-1 hover:ring-2 hover:ring-indigo-400';
      div.title = item.title;
      div.onclick = function() {
        if (window._mediaModalOnSelect) window._mediaModalOnSelect(item._id, item.url);
        closeMediaModal();
      };
      if (item.type === 'image') {
        div.innerHTML = `<img src="${item.url}" alt="${item.title}" class="w-full h-20 object-cover rounded" />`;
      } else {
        div.innerHTML = `<div class='w-full h-20 flex items-center justify-center text-2xl text-gray-400'><i class="fas fa-file"></i></div>`;
      }
      grid.appendChild(div);
    });
  } catch (e) {
    grid.innerHTML = '<div class="col-span-full text-center text-red-400">Failed to load media.</div>';
  }
}
document.getElementById('mediaFolderSelect').addEventListener('change', function() {
  loadMediaGrid(this.value);
});
// Upload new media
document.getElementById('mediaUploadForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);
  if (currentMediaFolder) formData.append('folder', currentMediaFolder);
  try {
    const res = await fetch('/api/media', { method: 'POST', body: formData });
    if (res.ok) {
      await loadMediaGrid(currentMediaFolder);
      form.reset();
    } else {
      alert('Upload failed');
    }
  } catch (e) { alert('Upload failed'); }
});
</script>
